<html>

<head>
  <title>Express</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>
  <h1>Express</h1>
  <p id="loggedin"></p>
  <button class="loggedin" onclick="localStorage.removeItem('token'); location.reload()">Logout</button>
  <button class="loggedin" id="createnote">Create note</button>
  <form hidden id="transformer">
    <p id="error" style="color:red;"></p>
    <p id="success" style="color:green;"></p>
    <input class="loggedout" hidden type="email" placeholder="email" id="email" />
    <input class="loggedout" type="text" placeholder="username" id="username" />
    <input class="loggedout" type="password" placeholder="password" id="passwd" />
    <textarea class="loggedin" rows="5" cols="80" id="note">
    </textarea>
    <input type="submit" />

  </form>

  



  <button class="loggedin" id="cringe4">Get self</button>.
  <button class="loggedout" hidden onClick="setupLogin()">Login</button>
  <button class="loggedout" hidden onClick="setupRegister()">Register</button>
  <div id="res"></div>
  <script>
    const username_el = document.getElementById("username");
    const passwd_el = document.getElementById("passwd");
    const email_el = document.getElementById("email");
    const err_el = document.getElementById("error");
    const suc_el = document.getElementById("success");

    if (localStorage.getItem("token")) {
      console.log("hello")
      document.querySelectorAll(".loggedout").forEach((e) => e.hidden = true);
      document.querySelectorAll(".loggedin").forEach((e) => e.hidden = false);
      fetch("/users/me", { method: "get", headers: {authorization: localStorage.getItem("token")}}).then(res=> res.json()).then(data => { if (!data.ok) localStorage.removeItem("token"); else document.getElementById("loggedin").innerText = data.user.username;});
    }
    if (!localStorage.getItem("token")) {
      document.querySelectorAll(".loggedout").forEach((e) => e.hidden = false);
      document.querySelectorAll(".loggedin").forEach((e) => e.hidden = true);
    }
    const setupRegister = () => {
      let f = document.querySelector("#transformer");
      f.hidden = false;
      email_el.hidden = false;
      console.log(f)
      f.onsubmit = async (e) => {
        e.preventDefault();
        let res = await fetch("/users/register", {
          method: "POST", headers: {
            "Content-Type": "application/json"
          }, body: JSON.stringify({ username: username_el.value, password: passwd_el.value, email: email_el.value })
        });
        let data = await res.json()
        if (!data.ok) {
          err_el.innerText = data.msg;
        } else {
          suc_el.innerText = data.msg;
          setupLogin();
        }
        document.getElementById("res").innerText = JSON.stringify(data);
        return false;
      }
    }
    const setupLogin = () => {
      let f = document.querySelector("#transformer");
      f.hidden = false;
      email_el.hidden = true;
      console.log(f)
      f.onsubmit = async (e) => {
        e.preventDefault();
        let res = await fetch("/users/login", {
          method: "POST", headers: {
            "Content-Type": "application/json"
          }, body: JSON.stringify({ username: username_el.value, password: passwd_el.value })
        });
        let data = await res.json()
        if (!data.ok) {
          err_el.innerText = data.msg;
        } else {
          suc_el.innerText = data.msg;
          localStorage.setItem("token", data.token);
          location.reload();
        }
        document.getElementById("res").innerText =  JSON.stringify(data);
        return false;
      }
    }

    
    document.getElementById("cringe4").onclick = async () => {
      let res = await fetch("/users/me", {
        method: "get", headers: {
          authorization: localStorage.getItem("token")
        }
      });
      document.getElementById("res").innerText = await res.text();
    }
  </script>
</body>

</html>